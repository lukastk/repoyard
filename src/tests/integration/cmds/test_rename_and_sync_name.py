# AUTOGENERATED! DO NOT EDIT!

import asyncio
import pytest
from pathlib import Path

from repoyard.cmds import new_repo, delete_repo, sync_repo
from repoyard.cmds._rename_repo import rename_repo, RenameScope
from repoyard.cmds._sync_name import sync_name, SyncNameDirection
from repoyard._models import get_repoyard_meta, RepoPart, RepoMeta
from repoyard._remote_index import find_remote_repo_by_id, load_remote_index_cache
from repoyard.config import get_config

from ...integration.conftest import create_repoyards

@pytest.mark.integration
def test_rename_and_sync_name():
    """Test renaming repositories and syncing names."""
    asyncio.run(_test_rename_and_sync_name())

async def _test_rename_and_sync_name():
    remote_name, remote_rclone_path, config, config_path, data_path = create_repoyards()
    # Create and sync a repo first
    repo1 = new_repo(
        config_path=config_path,
        repo_name="original-name",
        storage_location=remote_name,
    )
    await sync_repo(config_path=config_path, repo_index_name=repo1)
    
    config = get_config(config_path)
    repo_meta1 = get_repoyard_meta(config).by_index_name[repo1]
    repo_id = repo_meta1.repo_id
    
    # Rename locally only
    new_index_name = await rename_repo(
        config_path=config_path,
        repo_index_name=repo1,
        new_name="locally-renamed",
        scope=RenameScope.LOCAL,
    )
    
    # Verify local name changed
    config = get_config(config_path)
    repoyard_meta = get_repoyard_meta(config)
    assert new_index_name in repoyard_meta.by_index_name
    assert repo1 not in repoyard_meta.by_index_name
    
    renamed_meta = repoyard_meta.by_index_name[new_index_name]
    assert renamed_meta.name == "locally-renamed"
    assert renamed_meta.repo_id == repo_id  # ID should be unchanged
    
    # Verify remote still has old name
    remote_index = await find_remote_repo_by_id(config, remote_name, repo_id)
    assert remote_index == repo1  # Remote should still have original name
    # Rename remote only (to match local)
    await rename_repo(
        config_path=config_path,
        repo_index_name=new_index_name,
        new_name="locally-renamed",  # Same as local
        scope=RenameScope.REMOTE,
    )
    
    # Verify remote now has new name
    config = get_config(config_path)
    remote_index = await find_remote_repo_by_id(config, remote_name, repo_id)
    assert "locally-renamed" in remote_index
    # Create another repo
    repo2 = new_repo(
        config_path=config_path,
        repo_name="both-test",
        storage_location=remote_name,
    )
    await sync_repo(config_path=config_path, repo_index_name=repo2)
    
    config = get_config(config_path)
    repo_meta2 = get_repoyard_meta(config).by_index_name[repo2]
    repo_id2 = repo_meta2.repo_id
    
    # Rename both local and remote
    new_index_name2 = await rename_repo(
        config_path=config_path,
        repo_index_name=repo2,
        new_name="renamed-both",
        scope=RenameScope.BOTH,
    )
    
    # Verify local changed
    config = get_config(config_path)
    repoyard_meta = get_repoyard_meta(config)
    assert new_index_name2 in repoyard_meta.by_index_name
    assert repo2 not in repoyard_meta.by_index_name
    
    # Verify remote changed
    remote_index = await find_remote_repo_by_id(config, remote_name, repo_id2)
    assert remote_index == new_index_name2
    # Create a repo and sync
    repo3 = new_repo(
        config_path=config_path,
        repo_name="sync-test-local",
        storage_location=remote_name,
    )
    await sync_repo(config_path=config_path, repo_index_name=repo3)
    
    config = get_config(config_path)
    repo_meta3 = get_repoyard_meta(config).by_index_name[repo3]
    repo_id3 = repo_meta3.repo_id
    
    # Rename local only to create name mismatch
    renamed_repo3 = await rename_repo(
        config_path=config_path,
        repo_index_name=repo3,
        new_name="sync-test-local-renamed",
        scope=RenameScope.LOCAL,
    )
    
    # Verify names differ
    config = get_config(config_path)
    local_meta = get_repoyard_meta(config).by_index_name[renamed_repo3]
    remote_index = await find_remote_repo_by_id(config, remote_name, repo_id3)
    
    assert local_meta.name == "sync-test-local-renamed"
    _, remote_name_part = RepoMeta.parse_index_name(remote_index)
    assert remote_name_part == "sync-test-local"  # Still old name
    
    # Sync name from local to remote
    result = await sync_name(
        config_path=config_path,
        repo_index_name=renamed_repo3,
        direction=SyncNameDirection.TO_REMOTE,
    )
    
    # Verify remote now matches local
    config = get_config(config_path)
    remote_index = await find_remote_repo_by_id(config, remote_name, repo_id3)
    _, remote_name_after = RepoMeta.parse_index_name(remote_index)
    assert remote_name_after == "sync-test-local-renamed"
    # Create a repo and sync
    repo4 = new_repo(
        config_path=config_path,
        repo_name="sync-test-remote",
        storage_location=remote_name,
    )
    await sync_repo(config_path=config_path, repo_index_name=repo4)
    
    config = get_config(config_path)
    repo_meta4 = get_repoyard_meta(config).by_index_name[repo4]
    repo_id4 = repo_meta4.repo_id
    
    # Rename remote only to create name mismatch
    await rename_repo(
        config_path=config_path,
        repo_index_name=repo4,
        new_name="sync-test-remote-renamed",
        scope=RenameScope.REMOTE,
    )
    
    # Verify names differ
    config = get_config(config_path)
    local_meta = get_repoyard_meta(config).by_index_name[repo4]
    remote_index = await find_remote_repo_by_id(config, remote_name, repo_id4)
    
    assert local_meta.name == "sync-test-remote"  # Still old name
    _, remote_name_part = RepoMeta.parse_index_name(remote_index)
    assert remote_name_part == "sync-test-remote-renamed"
    
    # Sync name from remote to local
    result = await sync_name(
        config_path=config_path,
        repo_index_name=repo4,
        direction=SyncNameDirection.TO_LOCAL,
    )
    
    # Verify local now matches remote
    config = get_config(config_path)
    repoyard_meta = get_repoyard_meta(config)
    assert result in repoyard_meta.by_index_name
    local_meta_after = repoyard_meta.by_index_name[result]
    assert local_meta_after.name == "sync-test-remote-renamed"
    # Check that the remote index cache was updated properly
    config = get_config(config_path)
    cache = load_remote_index_cache(config, remote_name)
    
    # All our renamed repos should have updated cache entries
    assert repo_id in cache
    assert "locally-renamed" in cache[repo_id]
    
    assert repo_id2 in cache
    assert "renamed-both" in cache[repo_id2]
    
    print("All rename and sync_name tests passed!")
