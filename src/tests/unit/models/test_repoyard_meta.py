# AUTOGENERATED! DO NOT EDIT! File to edit: pts/tests/unit/models/test_repoyard_meta.pct.py

__all__ = ['TestById', 'TestByIndexName', 'TestByStorageLocation', 'TestIndexConsistency', 'TestRepoyardMetaConstruction', 'TestRepoyardMetaEdgeCases', 'sample_repo_metas']

# %% pts/tests/unit/models/test_repoyard_meta.pct.py 2
import pytest
from datetime import datetime, timezone
from pathlib import Path
from unittest.mock import MagicMock, patch

from repoyard._models import RepoMeta, RepoyardMeta


# ============================================================================
# Fixtures
# ============================================================================

# %% pts/tests/unit/models/test_repoyard_meta.pct.py 3
@pytest.fixture
def sample_repo_metas():
    """Create sample RepoMeta instances for testing."""
    return [
        RepoMeta(
            creation_timestamp_utc="20251120_100000",
            repo_subid="abc12",
            name="project-alpha",
            storage_location="default",
            creator_hostname="host1",
            groups=["backend", "python"],
        ),
        RepoMeta(
            creation_timestamp_utc="20251121_110000",
            repo_subid="def34",
            name="project-beta",
            storage_location="default",
            creator_hostname="host1",
            groups=["frontend"],
        ),
        RepoMeta(
            creation_timestamp_utc="20251122_120000",
            repo_subid="ghi56",
            name="project-gamma",
            storage_location="backup",
            creator_hostname="host2",
            groups=["backend"],
        ),
        RepoMeta(
            creation_timestamp_utc="20251123",
            repo_subid="jkl78",
            name="project-delta",
            storage_location="backup",
            creator_hostname="host2",
            groups=[],
        ),
    ]


# ============================================================================
# Tests for RepoyardMeta construction
# ============================================================================

# %% pts/tests/unit/models/test_repoyard_meta.pct.py 4
class TestRepoyardMetaConstruction:
    """Tests for RepoyardMeta basic construction."""

    def test_construction_with_empty_list(self):
        """RepoyardMeta can be created with an empty list."""
        meta = RepoyardMeta(repo_metas=[])
        assert meta.repo_metas == []

    def test_construction_with_repo_metas(self, sample_repo_metas):
        """RepoyardMeta stores repo_metas correctly."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)
        assert len(meta.repo_metas) == 4
        assert meta.repo_metas[0].name == "project-alpha"
        assert meta.repo_metas[3].name == "project-delta"


# ============================================================================
# Tests for by_storage_location property
# ============================================================================

# %% pts/tests/unit/models/test_repoyard_meta.pct.py 5
class TestByStorageLocation:
    """Tests for the by_storage_location cached property."""

    def test_by_storage_location_groups_correctly(self, sample_repo_metas):
        """Repos are grouped by storage location."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)
        by_sl = meta.by_storage_location

        assert "default" in by_sl
        assert "backup" in by_sl
        assert len(by_sl) == 2

    def test_by_storage_location_contains_correct_repos(self, sample_repo_metas):
        """Each storage location contains the correct repos."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)
        by_sl = meta.by_storage_location

        # Default storage should have alpha and beta
        assert len(by_sl["default"]) == 2
        assert "20251120_100000_abc12__project-alpha" in by_sl["default"]
        assert "20251121_110000_def34__project-beta" in by_sl["default"]

        # Backup storage should have gamma and delta
        assert len(by_sl["backup"]) == 2
        assert "20251122_120000_ghi56__project-gamma" in by_sl["backup"]
        assert "20251123_jkl78__project-delta" in by_sl["backup"]

    def test_by_storage_location_indexed_by_index_name(self, sample_repo_metas):
        """Repos are indexed by index_name within storage location."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)
        by_sl = meta.by_storage_location

        repo = by_sl["default"]["20251120_100000_abc12__project-alpha"]
        assert repo.name == "project-alpha"
        assert repo.repo_subid == "abc12"

    def test_by_storage_location_empty_repoyard(self):
        """Empty RepoyardMeta returns empty dict."""
        meta = RepoyardMeta(repo_metas=[])
        assert meta.by_storage_location == {}

    def test_by_storage_location_returns_consistent_results(self, sample_repo_metas):
        """by_storage_location returns consistent results on multiple calls."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)

        first_call = meta.by_storage_location
        second_call = meta.by_storage_location

        # Results should be equal (same content)
        assert first_call == second_call


# ============================================================================
# Tests for by_id property
# ============================================================================

# %% pts/tests/unit/models/test_repoyard_meta.pct.py 6
class TestById:
    """Tests for the by_id cached property."""

    def test_by_id_contains_all_repos(self, sample_repo_metas):
        """All repos are accessible by their repo_id."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)
        by_id = meta.by_id

        assert len(by_id) == 4
        assert "20251120_100000_abc12" in by_id
        assert "20251121_110000_def34" in by_id
        assert "20251122_120000_ghi56" in by_id
        assert "20251123_jkl78" in by_id

    def test_by_id_returns_correct_repo(self, sample_repo_metas):
        """Correct RepoMeta is returned for each repo_id."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)
        by_id = meta.by_id

        repo = by_id["20251120_100000_abc12"]
        assert repo.name == "project-alpha"
        assert repo.storage_location == "default"

        repo = by_id["20251123_jkl78"]
        assert repo.name == "project-delta"
        assert repo.storage_location == "backup"

    def test_by_id_empty_repoyard(self):
        """Empty RepoyardMeta returns empty dict."""
        meta = RepoyardMeta(repo_metas=[])
        assert meta.by_id == {}

    def test_by_id_returns_consistent_results(self, sample_repo_metas):
        """by_id returns consistent results on multiple calls."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)

        first_call = meta.by_id
        second_call = meta.by_id

        # Results should be equal (same content)
        assert first_call == second_call


# ============================================================================
# Tests for by_index_name property
# ============================================================================

# %% pts/tests/unit/models/test_repoyard_meta.pct.py 7
class TestByIndexName:
    """Tests for the by_index_name cached property."""

    def test_by_index_name_contains_all_repos(self, sample_repo_metas):
        """All repos are accessible by their index_name."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)
        by_name = meta.by_index_name

        assert len(by_name) == 4
        assert "20251120_100000_abc12__project-alpha" in by_name
        assert "20251121_110000_def34__project-beta" in by_name
        assert "20251122_120000_ghi56__project-gamma" in by_name
        assert "20251123_jkl78__project-delta" in by_name

    def test_by_index_name_returns_correct_repo(self, sample_repo_metas):
        """Correct RepoMeta is returned for each index_name."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)
        by_name = meta.by_index_name

        repo = by_name["20251120_100000_abc12__project-alpha"]
        assert repo.name == "project-alpha"
        assert repo.repo_subid == "abc12"
        assert repo.groups == ["backend", "python"]

    def test_by_index_name_empty_repoyard(self):
        """Empty RepoyardMeta returns empty dict."""
        meta = RepoyardMeta(repo_metas=[])
        assert meta.by_index_name == {}

    def test_by_index_name_returns_consistent_results(self, sample_repo_metas):
        """by_index_name returns consistent results on multiple calls."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)

        first_call = meta.by_index_name
        second_call = meta.by_index_name

        # Results should be equal (same content)
        assert first_call == second_call


# ============================================================================
# Tests for index consistency
# ============================================================================

# %% pts/tests/unit/models/test_repoyard_meta.pct.py 8
class TestIndexConsistency:
    """Tests that all indexes refer to the same RepoMeta objects."""

    def test_all_indexes_refer_to_same_objects(self, sample_repo_metas):
        """All index lookups return the same RepoMeta instance."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)

        # Get the same repo through different indexes
        repo_alpha = sample_repo_metas[0]

        by_sl_repo = meta.by_storage_location["default"]["20251120_100000_abc12__project-alpha"]
        by_id_repo = meta.by_id["20251120_100000_abc12"]
        by_name_repo = meta.by_index_name["20251120_100000_abc12__project-alpha"]

        # All should be the exact same object
        assert by_sl_repo is by_id_repo
        assert by_id_repo is by_name_repo
        assert by_name_repo is repo_alpha

    def test_indexes_work_with_date_only_timestamp(self, sample_repo_metas):
        """Indexes work correctly with date-only timestamp format."""
        meta = RepoyardMeta(repo_metas=sample_repo_metas)

        # project-delta uses date-only format
        repo = meta.by_id["20251123_jkl78"]
        assert repo.name == "project-delta"

        repo_by_name = meta.by_index_name["20251123_jkl78__project-delta"]
        assert repo_by_name is repo


# ============================================================================
# Tests for edge cases
# ============================================================================

# %% pts/tests/unit/models/test_repoyard_meta.pct.py 9
class TestRepoyardMetaEdgeCases:
    """Tests for edge cases in RepoyardMeta."""

    def test_single_repo(self):
        """RepoyardMeta works with a single repo."""
        repo = RepoMeta(
            creation_timestamp_utc="20251122_143022",
            repo_subid="a7kx9",
            name="single",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )
        meta = RepoyardMeta(repo_metas=[repo])

        assert len(meta.by_storage_location) == 1
        assert len(meta.by_storage_location["default"]) == 1
        assert len(meta.by_id) == 1
        assert len(meta.by_index_name) == 1

    def test_multiple_repos_same_name_different_ids(self):
        """Multiple repos can have the same name but different IDs."""
        repo1 = RepoMeta(
            creation_timestamp_utc="20251122_143022",
            repo_subid="abc12",
            name="duplicate-name",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )
        repo2 = RepoMeta(
            creation_timestamp_utc="20251123_143022",
            repo_subid="def34",
            name="duplicate-name",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )
        meta = RepoyardMeta(repo_metas=[repo1, repo2])

        # Both should be in indexes
        assert len(meta.by_id) == 2
        assert len(meta.by_index_name) == 2

        # Should be accessible by their unique IDs
        assert meta.by_id["20251122_143022_abc12"].name == "duplicate-name"
        assert meta.by_id["20251123_143022_def34"].name == "duplicate-name"

    def test_all_storage_locations_listed(self):
        """All unique storage locations appear in by_storage_location keys."""
        repos = [
            RepoMeta(
                creation_timestamp_utc="20251122_143022",
                repo_subid="abc12",
                name="repo1",
                storage_location="loc1",
                creator_hostname="host",
                groups=[],
            ),
            RepoMeta(
                creation_timestamp_utc="20251123_143022",
                repo_subid="def34",
                name="repo2",
                storage_location="loc2",
                creator_hostname="host",
                groups=[],
            ),
            RepoMeta(
                creation_timestamp_utc="20251124_143022",
                repo_subid="ghi56",
                name="repo3",
                storage_location="loc3",
                creator_hostname="host",
                groups=[],
            ),
        ]
        meta = RepoyardMeta(repo_metas=repos)

        assert set(meta.by_storage_location.keys()) == {"loc1", "loc2", "loc3"}
