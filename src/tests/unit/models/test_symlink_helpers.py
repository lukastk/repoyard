# AUTOGENERATED! DO NOT EDIT! File to edit: pts/tests/unit/models/test_symlink_helpers.pct.py

__all__ = ['TestGetBoxGroupConfigs', 'TestGroupMembershipChecks', 'TestSymlinkConflictHandling', 'TestSymlinkNameResolution', 'TestSymlinkTitleGeneration', 'mock_config', 'sample_box_metas']

# %% pts/tests/unit/models/test_symlink_helpers.pct.py 2
import pytest
from unittest.mock import MagicMock
from pathlib import Path

from boxyard._models import BoxMeta, get_box_group_configs
from boxyard.config import BoxGroupConfig, VirtualBoxGroupConfig, BoxGroupTitleMode


# ============================================================================
# Fixtures
# ============================================================================

# %% pts/tests/unit/models/test_symlink_helpers.pct.py 3
@pytest.fixture
def mock_config():
    """Create a mock config with box groups and virtual groups."""
    config = MagicMock()
    config.box_groups = {
        "backend": BoxGroupConfig(symlink_name="backend-projects"),
        "frontend": BoxGroupConfig(box_title_mode=BoxGroupTitleMode.NAME),
    }
    config.virtual_box_groups = {
        "active": VirtualBoxGroupConfig(filter_expr="NOT archived"),
    }
    return config


@pytest.fixture
def sample_box_metas():
    """Create sample BoxMeta instances for testing."""
    return [
        BoxMeta(
            creation_timestamp_utc="20251120_100000",
            box_subid="abc12",
            name="project-alpha",
            storage_location="default",
            creator_hostname="host1",
            groups=["backend", "python"],
        ),
        BoxMeta(
            creation_timestamp_utc="20251121_110000",
            box_subid="def34",
            name="project-beta",
            storage_location="default",
            creator_hostname="host1",
            groups=["frontend", "custom-group"],
        ),
    ]


# ============================================================================
# Tests for get_box_group_configs
# ============================================================================

# %% pts/tests/unit/models/test_symlink_helpers.pct.py 4
class TestGetBoxGroupConfigs:
    """Tests for the get_box_group_configs function."""

    def test_returns_config_groups(self, mock_config, sample_box_metas):
        """Config groups are included in result."""
        groups, virtual_groups = get_box_group_configs(mock_config, sample_box_metas)

        assert "backend" in groups
        assert "frontend" in groups

    def test_returns_virtual_groups(self, mock_config, sample_box_metas):
        """Virtual groups are returned separately."""
        groups, virtual_groups = get_box_group_configs(mock_config, sample_box_metas)

        assert "active" in virtual_groups
        assert isinstance(virtual_groups["active"], VirtualBoxGroupConfig)

    def test_adds_groups_from_box_metas(self, mock_config, sample_box_metas):
        """Groups from box metas that aren't in config are added."""
        groups, virtual_groups = get_box_group_configs(mock_config, sample_box_metas)

        # "python" and "custom-group" are not in config but are in box metas
        assert "python" in groups
        assert "custom-group" in groups

    def test_new_groups_have_default_config(self, mock_config, sample_box_metas):
        """Groups not in config get default BoxGroupConfig."""
        groups, virtual_groups = get_box_group_configs(mock_config, sample_box_metas)

        # "python" should have default config
        assert isinstance(groups["python"], BoxGroupConfig)
        assert groups["python"].symlink_name is None
        assert groups["python"].box_title_mode == BoxGroupTitleMode.INDEX_NAME

    def test_preserves_config_group_settings(self, mock_config, sample_box_metas):
        """Groups from config preserve their settings."""
        groups, virtual_groups = get_box_group_configs(mock_config, sample_box_metas)

        # "backend" should keep its custom symlink_name
        assert groups["backend"].symlink_name == "backend-projects"

        # "frontend" should keep its custom title mode
        assert groups["frontend"].box_title_mode == BoxGroupTitleMode.NAME

    def test_does_not_modify_original_config(self, mock_config, sample_box_metas):
        """Original config.box_groups is not modified."""
        original_keys = set(mock_config.box_groups.keys())

        get_box_group_configs(mock_config, sample_box_metas)

        # Original config should not have new groups
        assert set(mock_config.box_groups.keys()) == original_keys

    def test_empty_box_metas(self, mock_config):
        """Works with empty box metas list."""
        groups, virtual_groups = get_box_group_configs(mock_config, [])

        # Should still have config groups
        assert "backend" in groups
        assert "frontend" in groups
        # But no groups from boxes
        assert "python" not in groups
        assert "custom-group" not in groups

    def test_box_with_no_groups(self, mock_config):
        """Handles boxes with no groups."""
        box = BoxMeta(
            creation_timestamp_utc="20251120_100000",
            box_subid="xyz99",
            name="no-groups-box",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )

        groups, virtual_groups = get_box_group_configs(mock_config, [box])

        # Should only have config groups
        assert set(groups.keys()) == {"backend", "frontend"}

    def test_empty_config_groups(self, sample_box_metas):
        """Works when config has no predefined groups."""
        config = MagicMock()
        config.box_groups = {}
        config.virtual_box_groups = {}

        groups, virtual_groups = get_box_group_configs(config, sample_box_metas)

        # Should have groups from box metas
        assert "backend" in groups
        assert "frontend" in groups
        assert "python" in groups
        assert "custom-group" in groups

    def test_duplicate_groups_in_boxes(self, mock_config):
        """Same group in multiple boxes is only added once."""
        boxes = [
            BoxMeta(
                creation_timestamp_utc="20251120_100000",
                box_subid="abc12",
                name="box1",
                storage_location="default",
                creator_hostname="host",
                groups=["shared-group"],
            ),
            BoxMeta(
                creation_timestamp_utc="20251121_100000",
                box_subid="def34",
                name="box2",
                storage_location="default",
                creator_hostname="host",
                groups=["shared-group"],
            ),
        ]

        groups, virtual_groups = get_box_group_configs(mock_config, boxes)

        # "shared-group" should appear once
        assert "shared-group" in groups
        # Count occurrences (should be exactly 1)
        count = sum(1 for g in groups if g == "shared-group")
        assert count == 1


# ============================================================================
# Tests for symlink title generation logic
# ============================================================================

# %% pts/tests/unit/models/test_symlink_helpers.pct.py 5
class TestSymlinkTitleGeneration:
    """Tests for symlink title generation based on BoxGroupTitleMode.

    These tests verify the title generation logic that would be used
    in create_user_box_group_symlinks.
    """

    @pytest.fixture
    def box_meta(self):
        """Create a sample BoxMeta for title testing."""
        return BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="a7kx9",
            name="my-project",
            storage_location="default",
            creator_hostname="host",
            groups=["backend"],
        )

    def test_title_mode_index_name(self, box_meta):
        """INDEX_NAME mode uses the full index_name."""
        config = BoxGroupConfig(box_title_mode=BoxGroupTitleMode.INDEX_NAME)

        # Simulate title generation logic
        if config.box_title_mode == BoxGroupTitleMode.INDEX_NAME:
            title = box_meta.index_name
        elif config.box_title_mode == BoxGroupTitleMode.DATETIME_AND_NAME:
            title = f"{box_meta.creation_timestamp_utc}__{box_meta.name}"
        elif config.box_title_mode == BoxGroupTitleMode.NAME:
            title = box_meta.name

        assert title == "20251122_143022_a7kx9__my-project"

    def test_title_mode_datetime_and_name(self, box_meta):
        """DATETIME_AND_NAME mode uses timestamp and name."""
        config = BoxGroupConfig(box_title_mode=BoxGroupTitleMode.DATETIME_AND_NAME)

        if config.box_title_mode == BoxGroupTitleMode.INDEX_NAME:
            title = box_meta.index_name
        elif config.box_title_mode == BoxGroupTitleMode.DATETIME_AND_NAME:
            title = f"{box_meta.creation_timestamp_utc}__{box_meta.name}"
        elif config.box_title_mode == BoxGroupTitleMode.NAME:
            title = box_meta.name

        assert title == "20251122_143022__my-project"

    def test_title_mode_name_only(self, box_meta):
        """NAME mode uses just the box name."""
        config = BoxGroupConfig(box_title_mode=BoxGroupTitleMode.NAME)

        if config.box_title_mode == BoxGroupTitleMode.INDEX_NAME:
            title = box_meta.index_name
        elif config.box_title_mode == BoxGroupTitleMode.DATETIME_AND_NAME:
            title = f"{box_meta.creation_timestamp_utc}__{box_meta.name}"
        elif config.box_title_mode == BoxGroupTitleMode.NAME:
            title = box_meta.name

        assert title == "my-project"

    def test_title_with_date_only_timestamp(self):
        """Title generation works with date-only timestamp."""
        box = BoxMeta(
            creation_timestamp_utc="20251122",
            box_subid="b8ly0",
            name="date-only-box",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )

        config = BoxGroupConfig(box_title_mode=BoxGroupTitleMode.DATETIME_AND_NAME)

        if config.box_title_mode == BoxGroupTitleMode.DATETIME_AND_NAME:
            title = f"{box.creation_timestamp_utc}__{box.name}"

        assert title == "20251122__date-only-box"

    def test_title_with_special_characters_in_name(self):
        """Title generation handles special characters in box name."""
        box = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="c9mz1",
            name="my-project_v2.0",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )

        config = BoxGroupConfig(box_title_mode=BoxGroupTitleMode.NAME)

        if config.box_title_mode == BoxGroupTitleMode.NAME:
            title = box.name

        assert title == "my-project_v2.0"


# ============================================================================
# Tests for symlink name resolution
# ============================================================================

# %% pts/tests/unit/models/test_symlink_helpers.pct.py 6
class TestSymlinkNameResolution:
    """Tests for resolving symlink folder names from group configs."""

    def test_custom_symlink_name(self):
        """Custom symlink_name is used when specified."""
        config = BoxGroupConfig(symlink_name="custom-folder")

        symlink_name = config.symlink_name or "default-group"

        assert symlink_name == "custom-folder"

    def test_none_symlink_name_uses_group_name(self):
        """None symlink_name falls back to group name."""
        config = BoxGroupConfig(symlink_name=None)
        group_name = "backend"

        symlink_name = config.symlink_name or group_name

        assert symlink_name == "backend"

    def test_empty_string_symlink_name(self):
        """Empty string symlink_name is used as-is (truthy check)."""
        config = BoxGroupConfig(symlink_name="")
        group_name = "backend"

        # Empty string is falsy, so it falls back
        symlink_name = config.symlink_name or group_name

        assert symlink_name == "backend"

    def test_virtual_group_symlink_name(self):
        """Virtual groups also support custom symlink names."""
        config = VirtualBoxGroupConfig(
            filter_expr="backend",
            symlink_name="all-backend-projects",
        )

        symlink_name = config.symlink_name or "virtual-backend"

        assert symlink_name == "all-backend-projects"


# ============================================================================
# Tests for group membership checks
# ============================================================================

# %% pts/tests/unit/models/test_symlink_helpers.pct.py 7
class TestGroupMembershipChecks:
    """Tests for checking if boxes belong to groups."""

    def test_box_in_regular_group(self):
        """Box with group tag is in that group."""
        box = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="test-box",
            storage_location="default",
            creator_hostname="host",
            groups=["backend", "python"],
        )

        assert "backend" in box.groups
        assert "python" in box.groups
        assert "frontend" not in box.groups

    def test_box_in_virtual_group_with_match(self):
        """Box matching virtual group filter is in that group."""
        box = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="test-box",
            storage_location="default",
            creator_hostname="host",
            groups=["backend", "active"],
        )

        virtual_config = VirtualBoxGroupConfig(filter_expr="backend AND active")

        assert virtual_config.is_in_group(box.groups) is True

    def test_box_not_in_virtual_group_without_match(self):
        """Box not matching virtual group filter is not in that group."""
        box = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="test-box",
            storage_location="default",
            creator_hostname="host",
            groups=["backend"],
        )

        virtual_config = VirtualBoxGroupConfig(filter_expr="backend AND frontend")

        assert virtual_config.is_in_group(box.groups) is False

    def test_box_excluded_by_not_filter(self):
        """Box is excluded by NOT filter in virtual group."""
        box = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="test-box",
            storage_location="default",
            creator_hostname="host",
            groups=["backend", "archived"],
        )

        virtual_config = VirtualBoxGroupConfig(filter_expr="backend AND NOT archived")

        assert virtual_config.is_in_group(box.groups) is False

    def test_box_with_empty_groups(self):
        """Box with no groups is not in any regular group."""
        box = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="test-box",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )

        assert "backend" not in box.groups
        assert len(box.groups) == 0

    def test_box_with_empty_groups_matches_not_filter(self):
        """Box with no groups can match NOT filters."""
        box = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="test-box",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )

        virtual_config = VirtualBoxGroupConfig(filter_expr="NOT archived")

        # Empty groups means "archived" is not present, so NOT archived is True
        assert virtual_config.is_in_group(box.groups) is True


# ============================================================================
# Tests for conflict handling (same title for different boxes)
# ============================================================================

# %% pts/tests/unit/models/test_symlink_helpers.pct.py 8
class TestSymlinkConflictHandling:
    """Tests for handling title conflicts when multiple boxes have same title."""

    def test_same_name_different_timestamps_index_name_mode(self):
        """With INDEX_NAME mode, same-name boxes have different titles."""
        box1 = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="my-project",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )
        box2 = BoxMeta(
            creation_timestamp_utc="20251123_143022",
            box_subid="def34",
            name="my-project",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )

        config = BoxGroupConfig(box_title_mode=BoxGroupTitleMode.INDEX_NAME)

        title1 = box1.index_name
        title2 = box2.index_name

        # Titles should be different due to different timestamps and subids
        assert title1 != title2
        assert title1 == "20251122_143022_abc12__my-project"
        assert title2 == "20251123_143022_def34__my-project"

    def test_same_name_name_mode_potential_conflict(self):
        """With NAME mode, same-name boxes would have the same title."""
        box1 = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="my-project",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )
        box2 = BoxMeta(
            creation_timestamp_utc="20251123_143022",
            box_subid="def34",
            name="my-project",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )

        config = BoxGroupConfig(box_title_mode=BoxGroupTitleMode.NAME)

        title1 = box1.name
        title2 = box2.name

        # Titles would be the same - this is a conflict scenario
        assert title1 == title2 == "my-project"

    def test_datetime_and_name_same_name_different_times(self):
        """With DATETIME_AND_NAME mode, different timestamps prevent conflicts."""
        box1 = BoxMeta(
            creation_timestamp_utc="20251122_143022",
            box_subid="abc12",
            name="my-project",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )
        box2 = BoxMeta(
            creation_timestamp_utc="20251123_143022",
            box_subid="def34",
            name="my-project",
            storage_location="default",
            creator_hostname="host",
            groups=[],
        )

        config = BoxGroupConfig(box_title_mode=BoxGroupTitleMode.DATETIME_AND_NAME)

        title1 = f"{box1.creation_timestamp_utc}__{box1.name}"
        title2 = f"{box2.creation_timestamp_utc}__{box2.name}"

        # Titles should be different due to different timestamps
        assert title1 != title2
        assert title1 == "20251122_143022__my-project"
        assert title2 == "20251123_143022__my-project"
