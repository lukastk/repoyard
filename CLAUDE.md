# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Repoyard is a Python CLI tool for managing and syncing repositories across local and remote storage using rclone. It tracks repository metadata, supports group management, and provides bidirectional sync with conflict detection.

## Development Commands

```bash
# Setup
uv sync                  # Install dependencies to .venv
direnv allow             # Auto-load environment
nbl install-hooks        # Git hooks for notebook validation

# Development (after editing .pct.py files)
nbl export --reverse     # Sync pts → nbs (REQUIRED after editing .pct.py)
nbl export               # Export nbs → pts → src/repoyard/
nbl clean                # Clean notebook outputs

# Testing
pytest tests/            # Run all tests
pytest tests/test_00_sync.py -v  # Run specific test file
nbl test                 # Test notebooks execute without errors

# Building
uv build                 # Create distribution in dist/

# Publishing
./publish_new_version.sh         # Interactive version bump, tag, and publish to PyPI
./publish_new_version.sh --test  # Publish to TestPyPI
```

## Architecture

### Notebook-First Development (nblite)

**Critical rules:**
1. **Never edit files in `src/repoyard/` directly** - they are autogenerated and will be overwritten
2. **After editing `.pct.py` files, always run `nbl export --reverse`** - otherwise your changes will be overwritten when `nbl export` runs

The export pipeline (defined in `nblite.toml`):
```
nbs/mod/*.ipynb → pts/mod/*.pct.py → src/repoyard/*.py
nbs/tests/*.ipynb → pts/tests/*.pct.py → tests/*.py
```

- `nbs/` - Jupyter notebooks (source of truth)
- `pts/` - Percent-format Python files (preferred for editing)
- `src/repoyard/` - Generated Python package (DO NOT EDIT)
- `tests/` - Generated test files

Git hook requires: when adding `nbs/X.ipynb`, must also add `pts/X.pct.py`.

### Editing Code

**Preferred: Edit `.pct.py` files** in `pts/mod/`. These are plaintext Python files using `# %%` cell delimiters.

Workflow:
1. Edit the `.pct.py` file
2. Run `nbl export --reverse` to sync back to `.ipynb`
3. Run `nbl export` to generate the Python module

### Key Directives

Place directives at the top of cells:

```python
# %%
#|default_exp core       # Set export target module (once per notebook, near top)

# %%
#|export                 # Export this cell to the module
def my_function():
    pass

# %%
#|exporti                # Export but exclude from __all__ (internal)

# %%
#|hide                   # Hide from docs (setup/testing cells)
```

### Function Export Mode

CLI commands use function export mode where the entire notebook becomes a single callable function:

```python
# %%
#|default_exp cmds._my_command
#|export_as_func true

# %%
#|top_export             # Module-level code (imports, outside function)
from pathlib import Path

# %%
#|set_func_signature     # Define the function signature
def my_command(arg1: str) -> dict:
    """Docstring here."""
    ...

# %%
#|export                 # Function body
result = do_something(arg1)

# %%
#|func_return            # Prepend 'return' to first line
result;
```

### Core Components

- **`src/repoyard/_models.py`** - Data models: `RepoMeta`, `RepoyardMeta`, `SyncRecord`, `SyncStatus`
- **`src/repoyard/config.py`** - Configuration: `StorageConfig`, `Config`
- **`src/repoyard/_cli/main.py`** - CLI commands (typer-based)
- **`src/repoyard/cmds/`** - Command implementations (init, new_repo, sync_repo, etc.)
- **`src/repoyard/_utils/`** - Utilities (rclone wrapper, sync helpers, async throttling)

### Key Concepts

- **repo_id**: `{timestamp}_{5-char-subid}` (e.g., `20251122_143022_a7kx9`)
- **index_name**: `{repo_id}__{name}` - unique identifier for each repo
- **Storage locations**: local filesystem or rclone remotes (S3, SFTP, etc.)
- **Sync records**: Track sync state between local/remote in `~/.repoyard/sync_records/`

### Configuration Paths

- Config file: `~/.config/repoyard/config.toml`
- rclone config: `~/.config/repoyard/repoyard_rclone.conf`
- Data directory: `~/.repoyard/`
- User repos: `~/repos/`
- Group symlinks: `~/repo-groups/`
