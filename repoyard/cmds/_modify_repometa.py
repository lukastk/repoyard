# AUTOGENERATED! DO NOT EDIT! File to edit: ../../../../../../../../../Users/lukastk/dev/2025-11-09_00__repoyard/pts/mod/cmds/05_modify_repometa.pct.py.

# %% top_export
from pathlib import Path
import subprocess
import os
from typing import Literal, Any

from repoyard._utils import get_repo_full_name_from_sub_path
from repoyard.config import get_config, StorageType
from repoyard import const

def modify_repometa(
    config_path: Path,
    repo_full_name: str,
    modifications: dict[str, Any] = {},
):
    """
    """
    
    # AUTOGENERATED! DO NOT EDIT! File to edit: ../../../../../../../../../Users/lukastk/dev/2025-11-09_00__repoyard/pts/mod/cmds/05_modify_repometa.pct.py.
    
    # %% auto 0
    __all__ = ['config', 'repoyard_meta', 'repo_meta', 'modified_repo_meta', 'repo_group_configs']
    
    # %% ../../../../../../../../../Users/lukastk/dev/2025-11-09_00__repoyard/pts/mod/cmds/05_modify_repometa.pct.py 11
    config = get_config(config_path)
    
    # %% ../../../../../../../../../Users/lukastk/dev/2025-11-09_00__repoyard/pts/mod/cmds/05_modify_repometa.pct.py 14
    from .._models import get_repoyard_meta, RepoMeta
    repoyard_meta = get_repoyard_meta(config)
    
    if repo_full_name not in repoyard_meta.by_full_name:
        raise ValueError(f"Repo '{repo_full_name}' not found.")
    
    repo_meta = repoyard_meta.by_full_name[repo_full_name]
    
    # %% ../../../../../../../../../Users/lukastk/dev/2025-11-09_00__repoyard/pts/mod/cmds/05_modify_repometa.pct.py 16
    modified_repo_meta = RepoMeta(**{
        **repo_meta.model_dump(),
        **modifications
    })
    
    # %% ../../../../../../../../../Users/lukastk/dev/2025-11-09_00__repoyard/pts/mod/cmds/05_modify_repometa.pct.py 18
    #TESTREF: test_modify_repometa_unique_names
    from .._models import get_repo_group_configs
    repo_group_configs = get_repo_group_configs(config, repoyard_meta.repo_metas)
    for g in repo_meta.groups:
        repo_group_config = repo_group_configs[g]
        repo_metas_in_group = [repo_meta for repo_meta in repoyard_meta.repo_metas if g in repo_meta.groups]
    
        if repo_group_config.unique_repo_names:
            name_counts = {repo_meta.name: 0 for repo_meta in repo_metas_in_group}
            for repo_meta in repo_metas_in_group:
                name_counts[repo_meta.name] += 1
            duplicate_names = [(name, count) for name, count in name_counts.items() if count > 1]
            if duplicate_names:
                names_str = ", ".join(f"'{name}' (count: {count})" for name, count in duplicate_names)
                raise ValueError(f"Error modifying repo meta for '{repo_full_name}':\n"
                                 f"Repo is in group '{g}' which requires unique names. After the modification, the following name(s) appear multiple times in this group: {names_str}.")
    
    # %% ../../../../../../../../../Users/lukastk/dev/2025-11-09_00__repoyard/pts/mod/cmds/05_modify_repometa.pct.py 20
    modified_repo_meta.save(config)
    
    # %% ../../../../../../../../../Users/lukastk/dev/2025-11-09_00__repoyard/pts/mod/cmds/05_modify_repometa.pct.py 23
    from .._models import refresh_repoyard_meta
    refresh_repoyard_meta(config)